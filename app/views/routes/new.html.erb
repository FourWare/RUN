<%= render 'form', route: @route %>

<script type="text/javascript">

var mapStyle = [
    {
        "featureType": "administrative",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "color": "#6195a0"
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "all",
        "stylers": [
            {
                "color": "#f2f2f2"
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#ffffff"
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "poi.park",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#e6f3d6"
            },
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "road",
        "elementType": "all",
        "stylers": [
            {
                "saturation": -100
            },
            {
                "lightness": 45
            },
            {
                "visibility": "simplified"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "simplified"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#ff8605"
            },
            {
                "visibility": "simplified"
            },
            {
                "saturation": "0"
            },
            {
                "lightness": "30"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "labels.text",
        "stylers": [
            {
                "color": "#4e4e4e"
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#f4f4f4"
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "color": "#787878"
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "transit",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "all",
        "stylers": [
            {
                "color": "#eaf6f8"
            },
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#eaf6f8"
            }
        ]
    }
]

var directionsDisplay = new google.maps.DirectionsRenderer({draggable: true});
var directionsService = new google.maps.DirectionsService();
var geocoder = new google.maps.Geocoder();
var from_lat = "";
var from_lng = "";
var to_lat = "";
var to_lng = "";
var waypoints = [];
function calcRoute() {
  var origin    = markers[0].getPosition();
  var destination = markers[1].getPosition();
  var request = {
      origin:      origin,
      destination: destination,
      travelMode:  google.maps.TravelMode.DRIVING
  };
    directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
      directionsDisplay.setMap(handler.getMap());
    }
  });
  markers[1].setMap(null);
  markers[0].setMap(null);
}

var markers = [];
handler = Gmaps.build('Google');
handler.buildMap({ internal: {id: 'mapEventCreate'}, 
  provider : {
    zoom: 15,
    center: new google.maps.LatLng(4.635540,-74.082807),
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    styles: mapStyle
  }
  });
  
  var myMap =handler.getMap();
  
  google.maps.event.addListener(handler.getMap(), 'click', function(event) {
    if(markers.length < 2){
  placeMarker(event.latLng);
    }
});
directionsDisplay.addListener(directionsDisplay, 'directions_changed', function() {
        computeTotalDistance(directionsDisplay.getDirections());
      });
      
var delMarker = function (markerPar) {
    removeMarker(markerPar);
}

function placeMarker(location) {
    var marker = new google.maps.Marker({
        position: location, 
        map: handler.getMap(),
        draggable: true
    });
    markers.push(marker);
    if (markers.length == 2){
      calcRoute();
    }
    google.maps.event.addListener(marker, 'click', function(event) {
      marker.setMap(null);
      var i = markers.indexOf(marker);
      if(i != -1) {
	      markers.splice(i, 1);
      }
    });
}

function getData(){

  from_lat = directionsDisplay.getDirections().routes[0].legs[0].start_location.lat();
  from_lng = directionsDisplay.getDirections().routes[0].legs[0].start_location.lng();
  to_lat = directionsDisplay.getDirections().routes[0].legs[0].end_location.lat();
  to_lng = directionsDisplay.getDirections().routes[0].legs[0].end_location.lng();
  waypoints = directionsDisplay.getDirections().routes[0].legs[0].via_waypoints;
  
  var waypnts = []

for (i = 0; i < waypoints.length; i++) { 
    waypnts.push(  {
      id: i,
      lat: waypoints[i].lat(),
      lng: waypoints[i].lng()
      });
  }
var myJSON = JSON.stringify(waypnts);

  document.getElementById("route_from_lat").value = from_lat;
  document.getElementById("route_from_lng").value = from_lng;
  document.getElementById("route_to_lat").value = to_lat;
  document.getElementById("route_to_lng").value = to_lng;
  document.getElementById("route_waypoints").value = myJSON;
  document.getElementById("route_form").submit();
}

function geocodeAddress() {
        var address = document.getElementById('address').value;
        geocoder.geocode({'address': address}, function(results, status) {
          if (status === 'OK') {
            myMap.setCenter(results[0].geometry.location);
          } else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      }
</script>